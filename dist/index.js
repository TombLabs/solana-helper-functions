var n=require("@metaplex-foundation/mpl-token-metadata"),e=require("@metaplex-foundation/umi"),t=require("@metaplex-foundation/umi-bundle-defaults"),r=require("isomorphic-unfetch"),i=require("@coral-xyz/anchor"),o=require("@solana/web3.js");function s(n){return n&&"object"==typeof n&&"default"in n?n:{default:n}}var a=/*#__PURE__*/s(r);function u(n,e,t){if(!n.s){if(t instanceof c){if(!t.s)return void(t.o=u.bind(null,n,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(u.bind(null,n,e),u.bind(null,n,2));n.s=e,n.v=t;const r=n.o;r&&r(n)}}var c=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(e,t){var r=new n,i=this.s;if(i){var o=1&i?e:t;if(o){try{u(r,1,o(this.v))}catch(n){u(r,2,n)}return r}return this}return this.o=function(n){try{var i=n.v;1&n.s?u(r,1,e?e(i):i):t?u(r,1,t(i)):u(r,2,i)}catch(n){u(r,2,n)}},r},n}();function f(n){return n instanceof c&&1&n.s}function l(n,e){try{var t=n()}catch(n){return e(n)}return t&&t.then?t.then(void 0,e):t}function h(n,e,t){if(!n.s){if(t instanceof v){if(!t.s)return void(t.o=h.bind(null,n,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(h.bind(null,n,e),h.bind(null,n,2));n.s=e,n.v=t;const r=n.o;r&&r(n)}}var v=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(e,t){var r=new n,i=this.s;if(i){var o=1&i?e:t;if(o){try{h(r,1,o(this.v))}catch(n){h(r,2,n)}return r}return this}return this.o=function(n){try{var i=n.v;1&n.s?h(r,1,e?e(i):i):t?h(r,1,t(i)):h(r,2,i)}catch(n){h(r,2,n)}},r},n}();function m(n){return n instanceof v&&1&n.s}var d=function(n,e,t,r){try{return Promise.resolve(Promise.all(e.map(function(e){try{var s=t instanceof o.Keypair?new i.Wallet(t):t;return e instanceof o.Transaction?(e.recentBlockhash=r,e.feePayer=s.publicKey,Promise.resolve(s.signTransaction(e)).then(function(e){return Promise.resolve(n.sendRawTransaction(e.serialize(),{skipPreflight:!0,preflightCommitment:"confirmed"}))})):(e.message.recentBlockhash=r,Promise.resolve(s.signTransaction(e)).then(function(e){return Promise.resolve(n.sendRawTransaction(e.serialize(),{skipPreflight:!0,preflightCommitment:"confirmed"}))}))}catch(n){return Promise.reject(n)}}))).then(function(e){var t=[],r=!1,i=0,o=function(n,e,t){for(var r;;){var i=n();if(m(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=t();if(o&&o.then){if(!m(o)){r=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!m(s)){r=2;break}}}var a=new v,u=h.bind(null,a,2);return(0===r?i.then(f):1===r?o.then(c):s.then(l)).then(void 0,u),a;function c(r){o=r;do{if(e&&(s=e())&&s.then&&!m(s))return void s.then(l).then(void 0,u);if(!(i=n())||m(i)&&!i.v)return void h(a,1,o);if(i.then)return void i.then(f).then(void 0,u);m(o=t())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,u)}function f(n){n?(o=t())&&o.then?o.then(c).then(void 0,u):c(o):h(a,1,o)}function l(){(i=n())?i.then?i.then(f).then(void 0,u):f(i):h(a,1,o)}}(function(){return!r},void 0,function(){return Promise.resolve(g(5e3)).then(function(){return Promise.resolve(n.getSignatureStatuses(e)).then(function(n){console.log(n);var o=null==n?void 0:n.value;if(i>10)for(var s=0;s<o.length;s++){var a=o[s];t.push(null===a?{signature:e[s],error:!0,message:"Transaction dropped"}:null!==(null==a?void 0:a.err)?{signature:e[s],error:!0,message:"Transaction failed"}:"finalized"===(null==a?void 0:a.confirmationStatus)||"confirmed"===(null==a?void 0:a.confirmationStatus)?{signature:e[s],error:!1,message:"Transaction confirmed"}:{signature:e[s],error:!0,message:"Could not confirm transaction"}),r=!0;break}if(o.filter(function(n){return"confirmed"===(null==n?void 0:n.confirmationStatus)||"finalized"===(null==n?void 0:n.confirmationStatus)}).length===o.length)r=!0,t.push.apply(t,o.map(function(n,t){return{signature:e[t],error:!1,message:"Transaction confirmed"}}));else if(o.filter(function(n){return null===n}).length>0&&i<8);else{for(var u=0;u<o.length;u++){var c=o[u];t.push(null===c?{signature:e[u],error:!0,message:"Transaction dropped"}:null!==(null==c?void 0:c.err)?{signature:e[u],error:!0,message:"Transaction failed"}:"finalized"===(null==c?void 0:c.confirmationStatus)||"confirmed"===(null==c?void 0:c.confirmationStatus)?{signature:e[u],error:!1,message:"Transaction confirmed"}:{signature:e[u],error:!0,message:"Could not confirm transaction"})}r=!0}i++})})});return o&&o.then?o.then(function(){return t}):t})}catch(n){return Promise.reject(n)}},p=function(n,e,t,r){void 0===r&&(r=2e-5);try{var i,s=function(){var e=i.value.unitsConsumed+500,t=Math.floor(r/e*Math.pow(10,9))*Math.pow(10,6),s=e*(t/Math.pow(10,6));console.log("Expected fee: ",s/Math.pow(10,9)," SOL");var a=[o.ComputeBudgetProgram.setComputeUnitLimit({units:e}),o.ComputeBudgetProgram.setComputeUnitPrice({microLamports:t})];if(n instanceof o.Transaction)n.add.apply(n,a);else{var u,c=o.TransactionMessage.decompile(n.message);(u=c.instructions).unshift.apply(u,a),n.message=c.compileToV0Message()}return n},a=n instanceof o.Transaction?(n.feePayer=t,Promise.resolve(e.simulateTransaction(n)).then(function(n){i=n})):Promise.resolve(e.simulateTransaction(n)).then(function(n){i=n});return Promise.resolve(a&&a.then?a.then(s):s())}catch(n){return Promise.reject(n)}},g=function(n){try{return Promise.resolve(new Promise(function(e){return setTimeout(e,n)}))}catch(n){return Promise.reject(n)}};const y="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function P(n,e,t){if(!n.s){if(t instanceof b){if(!t.s)return void(t.o=P.bind(null,n,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(P.bind(null,n,e),P.bind(null,n,2));n.s=e,n.v=t;var r=n.o;r&&r(n)}}var b=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(e,t){var r=new n,i=this.s;if(i){var o=1&i?e:t;if(o){try{P(r,1,o(this.v))}catch(n){P(r,2,n)}return r}return this}return this.o=function(n){try{var i=n.v;1&n.s?P(r,1,e?e(i):i):t?P(r,1,t(i)):P(r,2,i)}catch(n){P(r,2,n)}},r},n}();function w(n){return n instanceof b&&1&n.s}exports.addComputeAndPriority=p,exports.getAssetsForWallet=function(r,i,o,s){void 0===s&&(s=!0);try{var h,v=function(s){return h?s:Promise.resolve(function(r,i){try{return Promise.resolve(l(function(){var o=t.createUmi(i).use(n.mplTokenMetadata());return Promise.resolve(n.fetchAllDigitalAssetByOwner(o,e.publicKey(r)))},function(n){return console.error(n),new Error("Error fetching assets")}))}catch(n){return Promise.reject(n)}}(r,i||"mainnet"===o?"https://api.mainnet-beta.solana.com":"devnet"===o?"https://api.devnet.solana.com":"testnet"===o?"https://api.testnet.solana.com":"localhost"===o?"http://localhost:8899":"https://api.mainnet-beta.solana.com"))};if(!r)return Promise.resolve(new Error("Address is required"));var m=function(n){return n.length>44||n.length<32?{error:!0,message:"Invalid public key length"}:function(n){return/^[A-HJ-NP-Za-km-z1-9]*$/.test(n)}(n)?{error:!1,message:"Valid public key"}:{error:!0,message:"Non base58 characters in public key"}}(r);if(m.error)return Promise.resolve(new Error(m.message));var d=function(){if(s&&"mainnet"===o)return Promise.resolve(function(n,e,t){void 0===t&&(t=!1);try{return Promise.resolve(l(function(){var r=1,i=[],o=function(n,e,t){for(var r;;){var i=n();if(f(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=t();if(o&&o.then){if(!f(o)){r=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!f(s)){r=2;break}}}var a=new c,l=u.bind(null,a,2);return(0===r?i.then(v):1===r?o.then(h):s.then(m)).then(void 0,l),a;function h(r){o=r;do{if(e&&(s=e())&&s.then&&!f(s))return void s.then(m).then(void 0,l);if(!(i=n())||f(i)&&!i.v)return void u(a,1,o);if(i.then)return void i.then(v).then(void 0,l);f(o=t())&&(o=o.v)}while(!o||!o.then);o.then(h).then(void 0,l)}function v(n){n?(o=t())&&o.then?o.then(h).then(void 0,l):h(o):u(a,1,o)}function m(){(i=n())?i.then?i.then(v).then(void 0,l):v(i):u(a,1,o)}}(function(){return!!r},void 0,function(){return Promise.resolve(a.default(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:1,method:"getAssetsByOwner",params:{ownerAddress:n,page:r,limit:100,options:{showUnverfifiedCollections:!t}}})})).then(function(n){return Promise.resolve(n.json()).then(function(n){i.push.apply(i,n.result.items),1e3!==n.result.total?r=!1:r++})})});return o&&o.then?o.then(function(){return i}):i},function(n){return console.error(n),new Error("Error fetching assets")}))}catch(n){return Promise.reject(n)}}(r,i)).then(function(n){return h=1,n});if(s&&"mainnet"!==o){var n=new Error("DAS is only available on mainnet");return h=1,n}}();return Promise.resolve(d&&d.then?d.then(v):v(d))}catch(n){return Promise.reject(n)}},exports.sendAndConfirmAllSmartTransactions=function(n,e,t,r){try{var i=function(){return Promise.resolve(t.getLatestBlockhash()).then(function(r){return Promise.resolve(d(t,e,n,r.blockhash))})},o=function(n,e,t){if("function"==typeof n[y]){var r,i,o,s=n[y]();if(function n(t){try{for(;!(r=s.next()).done;)if((t=e(r.value))&&t.then){if(!w(t))return void t.then(n,o||(o=P.bind(null,i=new b,2)));t=t.v}i?P(i,1,t):i=t}catch(n){P(i||(i=new b),2,n)}}(),s.return){var a=function(n){try{r.done||s.return()}catch(n){}return n};if(i&&i.then)return i.then(a,function(n){throw a(n)});a()}return i}if(!("length"in n))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<n.length;c++)u.push(n[c]);return function(n,e,t){var r,i,o=-1;return function t(s){try{for(;++o<n.length;)if((s=e(o))&&s.then){if(!w(s))return void s.then(t,i||(i=P.bind(null,r=new b,2)));s=s.v}r?P(r,1,s):r=s}catch(n){P(r||(r=new b),2,n)}}(),r}(u,function(n){return e(u[n])})}(e,function(e){return Promise.resolve(p(e,t,n.publicKey,r||2e-5)).then(function(n){e=n})});return Promise.resolve(o&&o.then?o.then(i):i())}catch(n){return Promise.reject(n)}},exports.sendAndConfirmTransactions=d;
