import{mplTokenMetadata as n,fetchAllDigitalAssetByOwner as e}from"@metaplex-foundation/mpl-token-metadata";import{publicKey as t}from"@metaplex-foundation/umi";import{createUmi as r}from"@metaplex-foundation/umi-bundle-defaults";import i from"isomorphic-unfetch";import{Wallet as o}from"@coral-xyz/anchor";import{Keypair as s,Transaction as a,ComputeBudgetProgram as u,TransactionMessage as c}from"@solana/web3.js";function f(n,e,t){if(!n.s){if(t instanceof l){if(!t.s)return void(t.o=f.bind(null,n,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(f.bind(null,n,e),f.bind(null,n,2));n.s=e,n.v=t;const r=n.o;r&&r(n)}}var l=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(e,t){var r=new n,i=this.s;if(i){var o=1&i?e:t;if(o){try{f(r,1,o(this.v))}catch(n){f(r,2,n)}return r}return this}return this.o=function(n){try{var i=n.v;1&n.s?f(r,1,e?e(i):i):t?f(r,1,t(i)):f(r,2,i)}catch(n){f(r,2,n)}},r},n}();function h(n){return n instanceof l&&1&n.s}function v(n,e){try{var t=n()}catch(n){return e(n)}return t&&t.then?t.then(void 0,e):t}var m=function(o,s,a,u){void 0===u&&(u=!0);try{var c,m=function(i){return c?i:Promise.resolve(function(i,o){try{return Promise.resolve(v(function(){var s=r(o).use(n());return Promise.resolve(e(s,t(i)))},function(n){return console.error(n),new Error("Error fetching assets")}))}catch(n){return Promise.reject(n)}}(o,s||"mainnet"===a?"https://api.mainnet-beta.solana.com":"devnet"===a?"https://api.devnet.solana.com":"testnet"===a?"https://api.testnet.solana.com":"localhost"===a?"http://localhost:8899":"https://api.mainnet-beta.solana.com"))};if(!o)return Promise.resolve(new Error("Address is required"));var d=function(n){return n.length>44||n.length<32?{error:!0,message:"Invalid public key length"}:function(n){return/^[A-HJ-NP-Za-km-z1-9]*$/.test(n)}(n)?{error:!1,message:"Valid public key"}:{error:!0,message:"Non base58 characters in public key"}}(o);if(d.error)return Promise.resolve(new Error(d.message));var p=function(){if(u&&"mainnet"===a)return Promise.resolve(function(n,e,t){void 0===t&&(t=!1);try{return Promise.resolve(v(function(){var r=1,o=[],s=function(n,e,t){for(var r;;){var i=n();if(h(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=t();if(o&&o.then){if(!h(o)){r=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!h(s)){r=2;break}}}var a=new l,u=f.bind(null,a,2);return(0===r?i.then(v):1===r?o.then(c):s.then(m)).then(void 0,u),a;function c(r){o=r;do{if(e&&(s=e())&&s.then&&!h(s))return void s.then(m).then(void 0,u);if(!(i=n())||h(i)&&!i.v)return void f(a,1,o);if(i.then)return void i.then(v).then(void 0,u);h(o=t())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,u)}function v(n){n?(o=t())&&o.then?o.then(c).then(void 0,u):c(o):f(a,1,o)}function m(){(i=n())?i.then?i.then(v).then(void 0,u):v(i):f(a,1,o)}}(function(){return!!r},void 0,function(){return Promise.resolve(i(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:1,method:"getAssetsByOwner",params:{ownerAddress:n,page:r,limit:100,options:{showUnverfifiedCollections:!t}}})})).then(function(n){return Promise.resolve(n.json()).then(function(n){o.push.apply(o,n.result.items),1e3!==n.result.total?r=!1:r++})})});return s&&s.then?s.then(function(){return o}):o},function(n){return console.error(n),new Error("Error fetching assets")}))}catch(n){return Promise.reject(n)}}(o,s)).then(function(n){return c=1,n});if(u&&"mainnet"!==a){var n=new Error("DAS is only available on mainnet");return c=1,n}}();return Promise.resolve(p&&p.then?p.then(m):m(p))}catch(n){return Promise.reject(n)}};function d(n,e,t){if(!n.s){if(t instanceof p){if(!t.s)return void(t.o=d.bind(null,n,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(d.bind(null,n,e),d.bind(null,n,2));n.s=e,n.v=t;const r=n.o;r&&r(n)}}var p=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(e,t){var r=new n,i=this.s;if(i){var o=1&i?e:t;if(o){try{d(r,1,o(this.v))}catch(n){d(r,2,n)}return r}return this}return this.o=function(n){try{var i=n.v;1&n.s?d(r,1,e?e(i):i):t?d(r,1,t(i)):d(r,2,i)}catch(n){d(r,2,n)}},r},n}();function g(n){return n instanceof p&&1&n.s}var y=function(n,e,t,r){try{return Promise.resolve(Promise.all(e.map(function(e){try{var i=t instanceof s?new o(t):t;return e instanceof a?(e.recentBlockhash=r,e.feePayer=i.publicKey,Promise.resolve(i.signTransaction(e)).then(function(e){return Promise.resolve(n.sendRawTransaction(e.serialize(),{skipPreflight:!0,preflightCommitment:"confirmed"}))})):(e.message.recentBlockhash=r,Promise.resolve(i.signTransaction(e)).then(function(e){return Promise.resolve(n.sendRawTransaction(e.serialize(),{skipPreflight:!0,preflightCommitment:"confirmed"}))}))}catch(n){return Promise.reject(n)}}))).then(function(e){var t=[],r=!1,i=0,o=function(n,e,t){for(var r;;){var i=n();if(g(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=t();if(o&&o.then){if(!g(o)){r=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!g(s)){r=2;break}}}var a=new p,u=d.bind(null,a,2);return(0===r?i.then(f):1===r?o.then(c):s.then(l)).then(void 0,u),a;function c(r){o=r;do{if(e&&(s=e())&&s.then&&!g(s))return void s.then(l).then(void 0,u);if(!(i=n())||g(i)&&!i.v)return void d(a,1,o);if(i.then)return void i.then(f).then(void 0,u);g(o=t())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,u)}function f(n){n?(o=t())&&o.then?o.then(c).then(void 0,u):c(o):d(a,1,o)}function l(){(i=n())?i.then?i.then(f).then(void 0,u):f(i):d(a,1,o)}}(function(){return!r},void 0,function(){return Promise.resolve(b(5e3)).then(function(){return Promise.resolve(n.getSignatureStatuses(e)).then(function(n){console.log(n);var o=null==n?void 0:n.value;if(i>10)for(var s=0;s<o.length;s++){var a=o[s];t.push(null===a?{signature:e[s],error:!0,message:"Transaction dropped"}:null!==(null==a?void 0:a.err)?{signature:e[s],error:!0,message:"Transaction failed"}:"finalized"===(null==a?void 0:a.confirmationStatus)||"confirmed"===(null==a?void 0:a.confirmationStatus)?{signature:e[s],error:!1,message:"Transaction confirmed"}:{signature:e[s],error:!0,message:"Could not confirm transaction"}),r=!0;break}if(o.filter(function(n){return"confirmed"===(null==n?void 0:n.confirmationStatus)||"finalized"===(null==n?void 0:n.confirmationStatus)}).length===o.length)r=!0,t.push.apply(t,o.map(function(n,t){return{signature:e[t],error:!1,message:"Transaction confirmed"}}));else if(o.filter(function(n){return null===n}).length>0&&i<8);else{for(var u=0;u<o.length;u++){var c=o[u];t.push(null===c?{signature:e[u],error:!0,message:"Transaction dropped"}:null!==(null==c?void 0:c.err)?{signature:e[u],error:!0,message:"Transaction failed"}:"finalized"===(null==c?void 0:c.confirmationStatus)||"confirmed"===(null==c?void 0:c.confirmationStatus)?{signature:e[u],error:!1,message:"Transaction confirmed"}:{signature:e[u],error:!0,message:"Could not confirm transaction"})}r=!0}i++})})});return o&&o.then?o.then(function(){return t}):t})}catch(n){return Promise.reject(n)}},P=function(n,e,t,r){void 0===r&&(r=2e-5);try{var i,o=function(){var e=i.value.unitsConsumed+500,t=Math.floor(r/e*Math.pow(10,9))*Math.pow(10,6),o=e*(t/Math.pow(10,6));console.log("Expected fee: ",o/Math.pow(10,9)," SOL");var s=[u.setComputeUnitLimit({units:e}),u.setComputeUnitPrice({microLamports:t})];if(n instanceof a)n.add.apply(n,s);else{var f,l=c.decompile(n.message);(f=l.instructions).unshift.apply(f,s),n.message=l.compileToV0Message()}return n},s=n instanceof a?(n.feePayer=t,Promise.resolve(e.simulateTransaction(n)).then(function(n){i=n})):Promise.resolve(e.simulateTransaction(n)).then(function(n){i=n});return Promise.resolve(s&&s.then?s.then(o):o())}catch(n){return Promise.reject(n)}},b=function(n){try{return Promise.resolve(new Promise(function(e){return setTimeout(e,n)}))}catch(n){return Promise.reject(n)}};const w="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function k(n,e,t){if(!n.s){if(t instanceof T){if(!t.s)return void(t.o=k.bind(null,n,e));1&e&&(e=t.s),t=t.v}if(t&&t.then)return void t.then(k.bind(null,n,e),k.bind(null,n,2));n.s=e,n.v=t;var r=n.o;r&&r(n)}}var T=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(e,t){var r=new n,i=this.s;if(i){var o=1&i?e:t;if(o){try{k(r,1,o(this.v))}catch(n){k(r,2,n)}return r}return this}return this.o=function(n){try{var i=n.v;1&n.s?k(r,1,e?e(i):i):t?k(r,1,t(i)):k(r,2,i)}catch(n){k(r,2,n)}},r},n}();function S(n){return n instanceof T&&1&n.s}var j=function(n,e,t,r){try{var i=function(){return Promise.resolve(t.getLatestBlockhash()).then(function(r){return Promise.resolve(y(t,e,n,r.blockhash))})},o=function(n,e,t){if("function"==typeof n[w]){var r,i,o,s=n[w]();if(function n(t){try{for(;!(r=s.next()).done;)if((t=e(r.value))&&t.then){if(!S(t))return void t.then(n,o||(o=k.bind(null,i=new T,2)));t=t.v}i?k(i,1,t):i=t}catch(n){k(i||(i=new T),2,n)}}(),s.return){var a=function(n){try{r.done||s.return()}catch(n){}return n};if(i&&i.then)return i.then(a,function(n){throw a(n)});a()}return i}if(!("length"in n))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<n.length;c++)u.push(n[c]);return function(n,e,t){var r,i,o=-1;return function t(s){try{for(;++o<n.length;)if((s=e(o))&&s.then){if(!S(s))return void s.then(t,i||(i=k.bind(null,r=new T,2)));s=s.v}r?k(r,1,s):r=s}catch(n){k(r||(r=new T),2,n)}}(),r}(u,function(n){return e(u[n])})}(e,function(e){return Promise.resolve(P(e,t,n.publicKey,r||2e-5)).then(function(n){e=n})});return Promise.resolve(o&&o.then?o.then(i):i())}catch(n){return Promise.reject(n)}};export{P as addComputeAndPriority,m as getAssetsForWallet,j as sendAndConfirmAllSmartTransactions,y as sendAndConfirmTransactions};
